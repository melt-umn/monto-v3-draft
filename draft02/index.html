<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<title>Monto Version 3 Specification, Draft 2</title>
		<style>
	body { font-family: sans-serif; }
	code, pre {
		background-color: #f8f8f8;
		font-family: monospace;
		tab-size: 4;
	}
	dt { font-weight: bold; }
	header > h1 { font-size: 30px; }
	main p { margin-left: 10px; }
	.anchorjs-link { color: #7f7f7f; }
	#TableOfContents { float: right; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.0.0/anchor.min.js"></script>

	</head>
	<body>
		<header>
			<h1>Monto Version 3 Specification, Draft 2</h1>
			<nav id="TableOfContents">
<ul>
<li><a href="#todos">TODOs</a></li>
<li><a href="#abstract">Abstract</a></li>
<li><a href="#1-conventions-and-terminology">1. Conventions and Terminology</a></li>
<li><a href="#2-introduction">2. Introduction</a></li>
<li><a href="#3-protocol-overview">3. Protocol Overview</a>
<ul>
<li><a href="#3-1-common-messages">3.1. Common Messages</a></li>
</ul></li>
<li><a href="#4-the-client-protocol">4. The Client Protocol</a>
<ul>
<li><a href="#4-1-connection-initiation">4.1. Connection Initiation</a></li>
<li><a href="#4-2-version-negotiation">4.2. Version Negotiation</a></li>
<li><a href="#4-3-sending-products">4.3. Sending Products</a></li>
<li><a href="#4-4-requesting-products">4.4. Requesting Products</a></li>
<li><a href="#4-5-client-protocol-messages">4.5. Client Protocol Messages</a></li>
<li><a href="#4-6-client-protocol-extensions">4.6. Client Protocol Extensions</a></li>
<li><a href="#4-7-miscellanea">4.7. Miscellanea</a></li>
</ul></li>
<li><a href="#5-the-service-protocol">5. The Service Protocol</a>
<ul>
<li><a href="#5-1-connection-initiation">5.1. Connection Initiation</a></li>
<li><a href="#5-2-version-negotiation">5.2. Version Negotiation</a></li>
<li><a href="#5-3-requesting-products">5.3. Requesting Products</a></li>
<li><a href="#5-4-service-protocol-messages">5.4. Service Protocol Messages</a></li>
<li><a href="#5-5-optimizations">5.5. Optimizations</a>
<ul>
<li><a href="#5-5-1-caching-the-dependency-graph">5.5.1. Caching the Dependency Graph</a></li>
<li><a href="#5-5-2-inferring-dependencies">5.5.2. Inferring Dependencies</a></li>
</ul></li>
<li><a href="#5-6-service-protocol-extensions">5.6. Service Protocol Extensions</a></li>
<li><a href="#5-7-miscellanea">5.7. Miscellanea</a></li>
</ul></li>
<li><a href="#6-products">6. Products</a></li>
<li><a href="#7-security-considerations">7. Security Considerations</a>
<ul>
<li><a href="#7-1-remote-access-to-local-files">7.1. Remote Access To Local Files</a></li>
<li><a href="#7-2-encrypted-transport">7.2. Encrypted Transport</a></li>
</ul></li>
<li><a href="#8-further-work">8. Further Work</a>
<ul>
<li><a href="#8-1-binary-encoding-instead-of-json">8.1. Binary Encoding instead of JSON</a></li>
<li><a href="#8-2-asynchronous-communication">8.2. Asynchronous Communication</a></li>
<li><a href="#8-3-commands">8.3. Commands</a></li>
<li><a href="#8-4-stateful-services">8.4. Stateful Services</a></li>
<li><a href="#8-5-caching-products">8.5. Caching Products</a></li>
<li><a href="#8-6-incremental-product-transfer">8.6. Incremental Product Transfer</a></li>
<li><a href="#8-7-incremental-compilation">8.7. Incremental Compilation</a></li>
<li><a href="#8-8-flow-control">8.8. Flow Control</a></li>
</ul></li>
<li><a href="#9-references">9. References</a>
<ul>
<li><a href="#9-1-normative-references">9.1. Normative References</a></li>
</ul></li>
</ul>
</nav>
		</header>
		<main>
			

<h1 id="todos">TODOs</h1>

<ul>
<li>Document configuration

<ul>
<li>Stateful or stateless config in the client protocol?</li>
</ul></li>
</ul>

<h1 id="abstract">Abstract</h1>

<p>This specification describes an improved iteration of the Monto protocol for Disintegrated Development Environments (<a href="#monto-2014">[MONTO-2014]</a><a href="#monto-2016">[MONTO-2016]</a>)
.
These improvements allow for simpler implementations for Clients.
They also make it feasible to have multiple Clients sharing a single Service, and for Services to be operated over the Internet (rather than on the local network or on a single machine).</p>

<h1 id="1-conventions-and-terminology">1. Conventions and Terminology</h1>

<p>The key words &ldquo;MUST&rdquo;, &ldquo;MUST NOT&rdquo;, &ldquo;REQUIRED&rdquo;, &ldquo;SHALL&rdquo;, &ldquo;SHALL NOT&rdquo;, &ldquo;SHOULD&rdquo;, &ldquo;SHOULD NOT&rdquo;, &ldquo;RECOMMENDED&rdquo;, &ldquo;MAY&rdquo;, and &ldquo;OPTIONAL&rdquo; in this document are to be interpreted as described in RFC 2119 (<a href="#rfc2119">[RFC2119]</a>)
.</p>

<p>Other terms used in this specification are as follows.</p>

<dl>
<dt>Client</dt>
<dd>An IDE, text editor, or other software directly controlled by the end user.</dd>
<dt>Broker</dt>
<dd>A per-user piece of software that manages communication between Clients and Services.</dd>
<dt>Service</dt>
<dd>A piece of software that receives Products from a Broker, and uses them to produce other Products in response.</dd>
<dt>Message</dt>
<dd>A single JSON value sent as an HTTP request or response body.</dd>
<dt>Product</dt>
<dd>Structured data sent between Clients, Brokers, and Services.</dd>
<dt>Client Protocol</dt>
<dd>The protocol used to communicate between Clients and Brokers.</dd>
<dt>Service Protocol</dt>
<dd>The protocol used to communicate between Brokers and Services.</dd>
<dt>Monto Protocols</dt>
<dd>The Client Protocol and Service Protocol.</dd>
</dl>

<h1 id="2-introduction">2. Introduction</h1>

<p>Monto makes it easy to interface the information provided by a language&rsquo;s compiler with various editors, without the compiler developer needing to implement language support for each editor.
Unfortunately, the native APIs of various popular editors vary widely with respect to how well they support the features required by Monto, namely the ability to bind to Ã˜MQ (<a href="#zeromq">[ZEROMQ]</a>)
 and the relatively large amount of client-side &ldquo;bookkeeping&rdquo; to be done.</p>

<p>This document suggests changes to the Monto Protocols which are focused on removing the ZeroMQ requirement and simplifying the protocol that the client has to support as much as possible.
As these changes are not backwards compatible with existing Clients and Services, these changes are collectively known as Monto Version 3.</p>

<h1 id="3-protocol-overview">3. Protocol Overview</h1>

<p>The Monto Protocols are built on top of HTTP/2 (<a href="#rfc7540">[RFC7540]</a>)
, with each request being a POST request to a special Monto endpoint.
Both request and response bodies are JSON (<a href="#rfc7159">[RFC7159]</a>)
.
This allows for the reuse of the many technologies that are capable of debugging this relatively common protocol combination, such as mitmproxy (<a href="#mitmproxy">[MITMPROXY]</a>)
, Postman (<a href="#postman">[POSTMAN]</a>)
, and others.
Furthermore, almost every mainstream programming language supports HTTP and JSON, meaning the wide variety of client programming languages (e.g. CoffeeScript, Emacs Lisp, Java, Python, etc.) can all interoperate with it.</p>

<p>Unless specified otherwise, a Message is serialized as JSON and sent with a Content-Type of <code>application/json</code>.</p>

<p>Both the Client Protocol and Service Protocol are versioned according to Semantic Versioning (<a href="#semver">[SEMVER]</a>)
.
This document describes Client Protocol version 3.0.0 and Service Protocol version 3.0.0.
It is hoped that this versioning scheme allows future updates to the protocol without causing gratuitous breakage in the ecosystem &ndash; a Client using a hypothetical version 3.1.0 protocol (without backwards compatibility) would not be able to connect to a Broker that only supports the version 3.0.0 Client Protocol, rather than being able to connect but having subtle semantic differences in the protocol.
Furthermore, the Broker can implement any backwards-compatibility that is needed; the separation between Client and Service protocols facilitates having Clients and Services that are speaking different versions of the protocols, as neither knows (nor cares) about the protocol the other is speaking.</p>

<p>Additionally, having an <code>extensions</code> field in the version allows for declaring that an implementation makes modifications to the specification in a way that can be detected by other components of the Monto, rather than again having secret semantic incompatibility.</p>

<h2 id="3-1-common-messages">3.1. Common Messages</h2>

<p>These Messages are shared by both the Client Protocol and the Service Protocol.</p>

<p>Messages are documented with JSON Schema (<a href="#jsonschema">[JSONSCHEMA]</a>)
.</p>

<p>The schemas are also present in the &ldquo;schemas&rdquo; directory, which should accompany this document.</p>

<p>









<h3 id="3-1-1-identifier">3.1.1. <code>Identifier</code></h3>

<h4 id="3-1-1-1-schema">3.1.1.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;Identifier&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A reverse-hostname-style dotted identifier, which must have at least two components.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;pattern&#34;</span>: <span style="color:#b44">&#34;[a-zA-Z_][a-zA-Z_0-9]*(\\.[a-zA-Z_][a-zA-Z_0-9]*)+&#34;</span>
}</code></pre>
</div>
<h4 id="3-1-1-2-example">3.1.1.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#b44">&#34;com.acme.foo&#34;</span></code></pre>
</div>











<h3 id="3-1-2-namespacedname">3.1.2. <code>NamespacedName</code></h3>

<h4 id="3-1-2-1-schema">3.1.2.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;NamespacedName&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A name after a dotted identifier.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;pattern&#34;</span>: <span style="color:#b44">&#34;[a-zA-Z_][a-zA-Z_0-9]*(\\.[a-zA-Z_][a-zA-Z_0-9]*)*/[a-zA-Z_][a-zA-Z_0-9]*&#34;</span>
}</code></pre>
</div>
<h4 id="3-1-2-2-example">3.1.2.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#b44">&#34;com.acme.foo/bar&#34;</span></code></pre>
</div>











<h3 id="3-1-3-product">3.1.3. <code>Product</code></h3>

<h4 id="3-1-3-1-schema">3.1.3.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;Product&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A Product, along with its contents.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;contents&#34;</span>: {},
		<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProductName.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> }
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;contents&#34;</span>, <span style="color:#b44">&#34;language&#34;</span>, <span style="color:#b44">&#34;name&#34;</span>, <span style="color:#b44">&#34;path&#34;</span>]
}</code></pre>
</div>
<h4 id="3-1-3-2-example">3.1.3.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: <span style="color:#b44">&#34;/foo/bar.py&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;contents&#34;</span>: []
}</code></pre>
</div>











<h3 id="3-1-4-productdescriptor">3.1.4. <code>ProductDescriptor</code></h3>

<h4 id="3-1-4-1-schema">3.1.4.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ProductDescriptor&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A Product&#39;s name and language.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProductName.json#&#34;</span> }
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;language&#34;</span>, <span style="color:#b44">&#34;name&#34;</span>]
}</code></pre>
</div>
<h4 id="3-1-4-2-example">3.1.4.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>
}</code></pre>
</div>











<h3 id="3-1-5-productidentifier">3.1.5. <code>ProductIdentifier</code></h3>

<h4 id="3-1-5-1-schema">3.1.5.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ProductIdentifier&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A Product&#39;s name, language, and path.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProductName.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> }
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;language&#34;</span>, <span style="color:#b44">&#34;name&#34;</span>, <span style="color:#b44">&#34;path&#34;</span>]
}</code></pre>
</div>
<h4 id="3-1-5-2-example">3.1.5.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: <span style="color:#b44">&#34;/foo/bar.py&#34;</span>
}</code></pre>
</div>











<h3 id="3-1-6-productname">3.1.6. <code>ProductName</code></h3>

<h4 id="3-1-6-1-schema">3.1.6.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ProductName&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The name of a Product.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;anyOf&#34;</span>: [
		{ <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;Identifier.json#&#34;</span> },
		{
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;BuiltInProductName&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The name of a Product defined by the specification.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;enum&#34;</span>: [
				<span style="color:#b44">&#34;directory&#34;</span>,
				<span style="color:#b44">&#34;errors&#34;</span>,
				<span style="color:#b44">&#34;highlighting&#34;</span>,
				<span style="color:#b44">&#34;source&#34;</span>
			]
		}
	]
}</code></pre>
</div>
<h4 id="3-1-6-2-example">3.1.6.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#b44">&#34;com.example.foo.bar&#34;</span></code></pre>
</div>











<h3 id="3-1-7-protocolversion">3.1.7. <code>ProtocolVersion</code></h3>

<h4 id="3-1-7-1-schema">3.1.7.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ProtocolVersion&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The version number of the Client or Service protocol.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span> }
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;major&#34;</span>, <span style="color:#b44">&#34;minor&#34;</span>, <span style="color:#b44">&#34;patch&#34;</span>]
}</code></pre>
</div>
<h4 id="3-1-7-2-example">3.1.7.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">3</span>,
	<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">0</span>,
	<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
}</code></pre>
</div>











<h3 id="3-1-8-softwareversion">3.1.8. <code>SoftwareVersion</code></h3>

<h4 id="3-1-8-1-schema">3.1.8.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;SoftwareVersion&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The version and implementation of a Client, Broker, or Service.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;id&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;Identifier.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;vendor&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span> }
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;id&#34;</span>]
}</code></pre>
</div>
<h4 id="3-1-8-2-example">3.1.8.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;id&#34;</span>: <span style="color:#b44">&#34;com.acme.foo&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;Foo Client&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;vendor&#34;</span>: <span style="color:#b44">&#34;ACME Inc.&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">0</span>,
	<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">1</span>,
	<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
}</code></pre>
</div>
</p>

<h1 id="4-the-client-protocol">4. The Client Protocol</h1>

<p>The Client Protocol dictates communication between Clients and Brokers.</p>

<h2 id="4-1-connection-initiation">4.1. Connection Initiation</h2>

<p>A Client SHALL initiate a connection to a Broker either when it starts, or when Monto capabilities are requested.
Although Monto can operate over connections on any port, Clients SHOULD default to connecting to port 28888 on the current machine, and Brokers SHOULD default to serving on that port.
Clients and Brokers SHOULD be able to connect to and serve on other ports, if configured to do so.</p>

<p>Upon initiating a connection to a Broker, a Client MUST attempt to use an HTTP/2 connection if the Client supports HTTP/2.
If the Client does not, it SHALL use the same protocol, but over HTTP/1.1 (<a href="#rfc7230">[RFC7230]</a>)
 instead.
If a Client is using HTTP/1.1, it MAY open multiple connections to the server in order to have multiple requests &ldquo;in flight&rdquo; at the same time.</p>

<h2 id="4-2-version-negotiation">4.2. Version Negotiation</h2>

<p>After the HTTP connection is established, the Client SHALL make a POST request to the <code>/monto/version</code> path, with a <a href="#4-5-1-clientnegotiation"><code>ClientNegotiation</code></a> Message as the body.
The Broker SHALL check that it is compatible with the Client.
The Broker SHALL respond with a <a href="#4-5-2-clientbrokernegotiation"><code>ClientBrokerNegotiation</code></a> Message.
If the Broker is compatible with the Client, this response SHALL have an HTTP Status of 200.
If the Broker determines itself to not be compatible with the Client, the response SHALL instead have an HTTP Status of 400.</p>

<p>If the HTTP Status is 200, the Client SHALL check that it is compatible with the Broker.
If the HTTP Status is not 200 or the Client and Broker are not compatible as determined by the Client, the Client SHOULD inform the user and MUST not attempt further interaction.</p>

<p>Compatibility between versions of the Client Protocol SHALL be determined using the Semantic Versioning rules.
Additionally, a Client MAY reject a Broker that is known to not follow this specification correctly, and vice versa.</p>

<p>All further requests to the Broker MUST have a <code>Monto-Version</code> HTTP header with the version of the Client Protocol negotiated stored as a <code>MAJOR.MINOR.PATCH</code> string.
For example, to declare that version 3.0.0 of the Client Protocol is in use, the header <code>Monto-Version: 3.0.0</code> would be sent.</p>

<p>If the intersection of the <code>extensions</code> field of the <a href="#4-5-1-clientnegotiation"><code>ClientNegotiation</code></a> and <a href="#4-5-2-clientbrokernegotiation"><code>ClientBrokerNegotiation</code></a> Messages is nonempty, the corresponding extensions SHALL be considered to be enabled by both the Client and the Broker.
The semantics of an extension being enabled are left to that extension.
All non-namespaced extensions are documented in the <a href="#4-6-client-protocol-extensions">Client Protocol Extensions</a> section below.</p>

<p>If a non-zero number of extensions are enabled, all requests from the Client to the Broker and all responses from the Broker to the Client MUST have <code>Monto-Extension</code> HTTP headers for each extension.
For example, if the extensions <code>com.acme/foo</code> and <code>org.example/bar</code> are enabled, the headers <code>Monto-Extension: com.acme/foo</code> and <code>Monto-Extension: org.example/bar</code> would be sent.</p>

<h2 id="4-3-sending-products">4.3. Sending Products</h2>

<p>When the user makes a change to a file that is not reflected by the file system, the Client SHOULD send the corresponding Product to the Broker.</p>

<p>To send a Product from the Client to the Broker, the Client SHALL make a PUT request to the <code>/monto/broker/[product-type]</code> path, where <code>[product-type]</code> corresponds to the type of Product being sent.
This is usually <a href="#6-4-source"><code>source</code></a> for a typical editor, although structural editors may send a different product type.
Additionally, the query string portion of the request URI MUST have a <code>path</code> key whose value is the path of the file that was sent.
A Client that knows the language the file is in SHOULD also add a <code>language</code> key whose value is the language of the file.</p>

<p>The body of the request SHALL be the Product being sent, with a <code>Content-Type</code> of <code>application/json</code>.
As a special case, if the Product being sent is a <a href="#6-4-source"><code>source</code></a> Product, the <code>Content-Type</code> MAY be <code>text/plain</code>.
In that case, the body of the request SHALL be the literal content of the <a href="#6-4-source"><code>source</code></a> Product.</p>

<p>If the <code>language</code> query parameter is not present, the Broker SHOULD attempt to detect it.
If it cannot be detected, the Broker MUST respond with an HTTP Status of 400 and a <a href="#4-5-3-brokerputerror"><code>BrokerPutError</code></a> Message with the <code>no_language</code> type as the body.
Otherwise, the Broker MUST respond with an HTTP Status of 204 and an empty body.</p>

<h2 id="4-4-requesting-products">4.4. Requesting Products</h2>

<p>A Client SHALL request Products by making a GET request to the <code>/monto/[service-id]/[product-type]</code> path, where <code>[product-type]</code> corresponds to the type of of Product being requested.
Additionally, the query string portion of the request URI MUST have <code>path</code> and <code>language</code> keys corresponding to the path and language corresponding to the Product being requested.</p>

<p>If the Service given by <code>[service-id]</code> does not exist, the Broker SHALL respond with an HTTP Status of 400 and a <a href="#4-5-4-brokergeterror"><code>BrokerGetError</code></a> Message with the <code>no_such_service</code> type as the body.</p>

<p>If the Product named by <code>[product-type]</code> is not exposed by the Service given by <code>[service-id]</code>, the Broker SHALL respond with an HTTP Status of 400 and a <a href="#4-5-4-brokergeterror"><code>BrokerGetError</code></a> Message with the <code>no_such_product</code> type as the body.</p>

<p>If the Product can be successfully computed, the Broker MUST respond with an HTTP Status of 200 and the Product as the body.
If the Product cannot be computed due to an error from a Service, the Broker MUST respond with an HTTP Status of 502 and a <a href="#4-5-4-brokergeterror"><code>BrokerGetError</code></a> Message with the <code>service_error</code> type as the body.
If the Product cannot be computed due to an error when connecting to a Service, the Broker MUST respond with an HTTP Status of 502 and a <a href="#4-5-4-brokergeterror"><code>BrokerGetError</code></a> Message with the <code>service_connect_error</code> type as the body.
If the Product cannot be computed due to an internal error, the Broker MUST respond with an HTTP Status of 500 and a <a href="#4-5-4-brokergeterror"><code>BrokerGetError</code></a> Message as the body.</p>

<h2 id="4-5-client-protocol-messages">4.5. Client Protocol Messages</h2>

<p>









<h3 id="4-5-1-clientnegotiation">4.5.1. <code>ClientNegotiation</code></h3>

<h4 id="4-5-1-1-schema">4.5.1.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ClientNegotiation&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Message that a Client sends to a Broker during version negotiation.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProtocolVersion.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;client&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;SoftwareVersion.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;extensions&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ClientExtensions&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Client Protocol extensions supported by the Client.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;minItems&#34;</span>: <span style="color:#666">1</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;NamespacedName.json#&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;uniqueItems&#34;</span>: <span style="color:#a2f;font-weight:bold">true</span>
		}
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;monto&#34;</span>, <span style="color:#b44">&#34;client&#34;</span>]
}</code></pre>
</div>
<h4 id="4-5-1-2-example">4.5.1.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">3</span>,
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
	},
	<span style="color:#008000;font-weight:bold">&#34;client&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;id&#34;</span>: <span style="color:#b44">&#34;com.acme.foo&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;Foo Client&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;vendor&#34;</span>: <span style="color:#b44">&#34;ACME Inc.&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">1</span>,
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
	},
	<span style="color:#008000;font-weight:bold">&#34;extensions&#34;</span>: [
		<span style="color:#b44">&#34;com.acme.foo/cool_thing&#34;</span>
	]
}</code></pre>
</div>











<h3 id="4-5-2-clientbrokernegotiation">4.5.2. <code>ClientBrokerNegotiation</code></h3>

<h4 id="4-5-2-1-schema">4.5.2.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ClientBrokerNegotiation&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Message that a Broker sends to a Client during version negotiation.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProtocolVersion.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;broker&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;SoftwareVersion.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;extensions&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ClientBrokerExtensions&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Client Protocol extensions supported by the Broker.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;minItems&#34;</span>: <span style="color:#666">1</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;NamespacedName.json#&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;uniqueItems&#34;</span>: <span style="color:#a2f;font-weight:bold">true</span>
		},
		<span style="color:#008000;font-weight:bold">&#34;services&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;BrokerServices&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Services the Broker is connected to.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ServiceNegotiation.json#&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;uniqueItems&#34;</span>: <span style="color:#a2f;font-weight:bold">true</span>
		}
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;monto&#34;</span>, <span style="color:#b44">&#34;broker&#34;</span>, <span style="color:#b44">&#34;services&#34;</span>]
}</code></pre>
</div>
<h4 id="4-5-2-2-example">4.5.2.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">3</span>,
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
	},
	<span style="color:#008000;font-weight:bold">&#34;broker&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;id&#34;</span>: <span style="color:#b44">&#34;com.acme.bar&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;Bar Broker&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;vendor&#34;</span>: <span style="color:#b44">&#34;ACME Inc.&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">1</span>,
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
	},
	<span style="color:#008000;font-weight:bold">&#34;extensions&#34;</span>: [
		<span style="color:#b44">&#34;com.acme.foo/cool_thing&#34;</span>,
		<span style="color:#b44">&#34;com.acme.bar/other_thing&#34;</span>
	],
	<span style="color:#008000;font-weight:bold">&#34;services&#34;</span>: [
		{
			<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">3</span>,
				<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">0</span>,
				<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
			},
			<span style="color:#008000;font-weight:bold">&#34;service&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;id&#34;</span>: <span style="color:#b44">&#34;com.acme.quux&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;Quux Service&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;vendor&#34;</span>: <span style="color:#b44">&#34;ACME Inc.&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">0</span>,
				<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">1</span>,
				<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
			},
			<span style="color:#008000;font-weight:bold">&#34;products&#34;</span>: []
		}
	]
}</code></pre>
</div>











<h3 id="4-5-3-brokerputerror">4.5.3. <code>BrokerPutError</code></h3>

<h4 id="4-5-3-1-schema">4.5.3.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;BrokerPutError&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;An error that occurs during the sending of a product from a Client to the Broker.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;oneOf&#34;</span>: [
		{
			<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;no_language&#34;</span> }
			},
			<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>],
			<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
		}
	]
}</code></pre>
</div>
<h4 id="4-5-3-2-example">4.5.3.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;no_language&#34;</span>
}</code></pre>
</div>











<h3 id="4-5-4-brokergeterror">4.5.4. <code>BrokerGetError</code></h3>

<h4 id="4-5-4-1-schema">4.5.4.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;BrokerGetError&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;An error that occurs during the requesting of a product by a Client.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;oneOf&#34;</span>: [
		{
			<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;no_such_service&#34;</span> }
			},
			<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>],
			<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
		},
		{
			<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;no_such_product&#34;</span> }
			},
			<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>],
			<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
		},
		{
			<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;service_error&#34;</span> },
				<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: {
					<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
					<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
						<span style="color:#008000;font-weight:bold">&#34;error&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
						<span style="color:#008000;font-weight:bold">&#34;service&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;Identifier.json#&#34;</span> }
					},
					<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;error&#34;</span>, <span style="color:#b44">&#34;service&#34;</span>],
					<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
				}
			},
			<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>, <span style="color:#b44">&#34;value&#34;</span>],
			<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
		},
		{
			<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;service_connect_error&#34;</span> },
				<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: {
					<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
					<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
						<span style="color:#008000;font-weight:bold">&#34;error&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
						<span style="color:#008000;font-weight:bold">&#34;service&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;Identifier.json#&#34;</span> }
					},
					<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;error&#34;</span>, <span style="color:#b44">&#34;service&#34;</span>],
					<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
				}
			},
			<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>, <span style="color:#b44">&#34;value&#34;</span>],
			<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
		}
	]
}</code></pre>
</div>
<h4 id="4-5-4-2-example">4.5.4.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;no_such_product&#34;</span>
}</code></pre>
</div>
</p>

<h2 id="4-6-client-protocol-extensions">4.6. Client Protocol Extensions</h2>

<p>Currently, there are no built-in extensions defined for the Client Protocol.
However, a Client or Broker MAY support arbitrary extensions whose names are in the form of the <a href="#3-1-2-namespacedname"><code>NamespacedName</code></a> above.
These extensions are vendor-specific, and thus not specified here.</p>

<h2 id="4-7-miscellanea">4.7. Miscellanea</h2>

<p>If a Client detects a violation in the protocol from the Broker, it SHOULD inform the user and MAY terminate.</p>

<p>If the Broker detects a violation in the protocol from a Client, it SHOULD NOT terminate, but MAY ignore the request, or ignore the Client completely.</p>

<h1 id="5-the-service-protocol">5. The Service Protocol</h1>

<p>The Service Protocol dictates communication between Brokers and Services.</p>

<h2 id="5-1-connection-initiation">5.1. Connection Initiation</h2>

<p>A Broker SHALL initiate a connection to the Services requested by the user when it starts.
Brokers MUST be able to connect to a Service on any port, and Services MUST be able to serve on any port.</p>

<p>Brokers MUST first attempt to use HTTP/2, and MAY support HTTP/1.1 as well.
Services SHOULD support HTTP/2 if at all possible, as the pipelining it allows is more useful than for the Client Protocol, as it is more likely that there are several in-flight requests at once.</p>

<h2 id="5-2-version-negotiation">5.2. Version Negotiation</h2>

<p>After the HTTP connection is established, the Broker SHALL make a POST request to the <code>/monto/version</code> path, with a <a href="#5-4-1-servicebrokernegotiation"><code>ServiceBrokerNegotiation</code></a> Message as the body.
The Service SHALL check that it is compatible with the Broker.
The Service SHALL respond with a <a href="#5-4-2-servicenegotiation"><code>ServiceNegotiation</code></a> Message.
If the Service is compatible with the Broker, this response SHALL have an HTTP Status of 200.
If the Service and Broker are not compatible, the response SHALL instead have an HTTP Status of 409.</p>

<p>If the HTTP Status is 200, the Broker SHALL check that it is compatible with the Service.
If the HTTP Status is not 200 or the Broker and Service are not compatible as determined by the Broker, the Broker MUST close the connection.
In this situation, the Broker SHOULD log this event, and MAY choose to ignore the Service&rsquo;s existence.</p>

<p>Compatibility between versions of the Service Protocol SHALL be determined using the Semantic Versioning rules.
Additionally, a Broker MAY reject a Service that is known to not follow this specification correctly, and vice versa.</p>

<p>If the intersection of the <code>extensions</code> field of the <code>ServiceBrokerNegotiation</code> and <code>ServiceNegotiation</code> Messages is nonempty, the corresponding extensions MUST be considered to be enabled by both the Client and the Broker.
The semantics of an extension being enabled are left to that extension.
All non-namespaced extensions are documented in the <a href="#5-6-service-protocol-extensions">Service Protocol Extensions</a> section below.</p>

<p>If a non-zero number of extensions are enabled, all requests from the Broker to the Service and all responses from the Service to the Broker MUST have a <code>Monto-Extensions</code> HTTP header with a space-separated list of the enabled extensions, sorted lexicographically.
For example, if the extensions <code>com.acme/foo</code> and <code>org.example/bar</code> are enabled, the header would read <code>Monto-Extensions: com.acme/foo org.example/bar</code>.
The header MAY be present with an empty value when no extensions are enabled.</p>

<h2 id="5-3-requesting-products">5.3. Requesting Products</h2>

<p>The broker SHALL request a Product from a Service by making a POST request to the <code>/monto/service</code> path, with a <a href="#5-4-3-brokerrequest"><code>BrokerRequest</code></a> as the body.</p>

<p>If the <code>BrokerRequest</code> Message contains a request for a Product which the Service does not expose, the Service MUST respond with an HTTP Status of 400 with the <code>ProductIdentifier</code> of the failed <code>BrokerRequest</code> as the body.</p>

<p>If the Service is unable to create the requested Product from the Products present in the <code>BrokerRequest</code>, the Service MUST respond with an HTTP Status of 500 and a <code>ServiceErrors</code> Message using the <code>ServiceErrorUnmetDependency</code> variant as the body.</p>

<p>If the Service encounters some other error, the Service MUST respond with an HTTP Status of 500 and a <code>ServiceErrors</code> Message using the <code>ServiceErrorOther</code> variant as the body.</p>

<p>Otherwise, the Service MUST respond with an HTTP Status of 200 and a <a href="#5-4-5-serviceproduct"><code>ServiceProduct</code></a> Message containing the requested Product as the Body.</p>

<h2 id="5-4-service-protocol-messages">5.4. Service Protocol Messages</h2>

<p>









<h3 id="5-4-1-servicebrokernegotiation">5.4.1. <code>ServiceBrokerNegotiation</code></h3>

<h4 id="5-4-1-1-schema">5.4.1.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceBrokerNegotiation&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Message that a Broker sends to a Service during version negotiation.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProtocolVersion.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;broker&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;SoftwareVersion.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;extensions&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceBrokerExtensions&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Service extensions supported by the Broker.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;minItems&#34;</span>: <span style="color:#666">1</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;NamespacedName.json#&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;uniqueItems&#34;</span>: <span style="color:#a2f;font-weight:bold">true</span>
		}
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;monto&#34;</span>, <span style="color:#b44">&#34;broker&#34;</span>]
}</code></pre>
</div>
<h4 id="5-4-1-2-example">5.4.1.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">3</span>,
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
	},
	<span style="color:#008000;font-weight:bold">&#34;broker&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;id&#34;</span>: <span style="color:#b44">&#34;com.acme.bar&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;Bar Broker&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;vendor&#34;</span>: <span style="color:#b44">&#34;ACME Inc.&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">1</span>,
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
	},
	<span style="color:#008000;font-weight:bold">&#34;extensions&#34;</span>: [
		<span style="color:#b44">&#34;com.acme.foo/cool_thing&#34;</span>,
		<span style="color:#b44">&#34;com.acme.bar/other_thing&#34;</span>
	]
}</code></pre>
</div>











<h3 id="5-4-2-servicenegotiation">5.4.2. <code>ServiceNegotiation</code></h3>

<h4 id="5-4-2-1-schema">5.4.2.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceNegotiation&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Message that a Service sends to a Broker during version negotiation.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProtocolVersion.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;service&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;SoftwareVersion.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;extensions&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceExtensions&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Service extensions supported by the Service.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;minItems&#34;</span>: <span style="color:#666">1</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;NamespacedName.json#&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;uniqueItems&#34;</span>: <span style="color:#a2f;font-weight:bold">true</span>
		},
		<span style="color:#008000;font-weight:bold">&#34;products&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;BrokerProductList&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;The Products a Service can produce.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProductDescriptor.json#&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;uniqueItems&#34;</span>: <span style="color:#a2f;font-weight:bold">true</span>
		}
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;monto&#34;</span>, <span style="color:#b44">&#34;service&#34;</span>, <span style="color:#b44">&#34;products&#34;</span>]
}</code></pre>
</div>
<h4 id="5-4-2-2-example">5.4.2.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;monto&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">3</span>,
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
	},
	<span style="color:#008000;font-weight:bold">&#34;service&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;id&#34;</span>: <span style="color:#b44">&#34;com.acme.quux&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;Quux Service&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;vendor&#34;</span>: <span style="color:#b44">&#34;ACME Inc.&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;major&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;minor&#34;</span>: <span style="color:#666">1</span>,
		<span style="color:#008000;font-weight:bold">&#34;patch&#34;</span>: <span style="color:#666">0</span>
	},
	<span style="color:#008000;font-weight:bold">&#34;products&#34;</span>: [
		{
			<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>
		},
		{
			<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;com.acme/styleguide&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>
		}
	],
	<span style="color:#008000;font-weight:bold">&#34;extensions&#34;</span>: [
		<span style="color:#b44">&#34;com.acme.quux/incremental&#34;</span>
	]
}</code></pre>
</div>











<h3 id="5-4-3-brokerrequest">5.4.3. <code>BrokerRequest</code></h3>

<h4 id="5-4-3-1-schema">5.4.3.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;BrokerRequest&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A request for a Product from the Broker to a Service.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;products&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;BrokerProducts&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;Products being provided along with the request.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;Product.json#&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;uniqueItems&#34;</span>: <span style="color:#a2f;font-weight:bold">true</span>
		},
		<span style="color:#008000;font-weight:bold">&#34;request&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProductIdentifier.json#&#34;</span> }
	},
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;request&#34;</span>]
}</code></pre>
</div>
<h4 id="5-4-3-2-example">5.4.3.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;products&#34;</span>: [],
	<span style="color:#008000;font-weight:bold">&#34;request&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: <span style="color:#b44">&#34;/foo/bar.py&#34;</span>
	}
}</code></pre>
</div>











<h3 id="5-4-4-serviceerrors">5.4.4. <code>ServiceErrors</code></h3>

<h4 id="5-4-4-1-schema">5.4.4.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceErrors&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;Errors encountered by a Service.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;errors&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;#/definitions/error&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;minItems&#34;</span>: <span style="color:#666">1</span>
		},
		<span style="color:#008000;font-weight:bold">&#34;notices&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ServiceNotice.json#&#34;</span> }
		}
	},
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;errors&#34;</span>],
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,

	<span style="color:#008000;font-weight:bold">&#34;definitions&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;error&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;oneOf&#34;</span>: [
				{
					<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceErrorUnmetDependency&#34;</span>,
					<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;An error representing a dependency not being present.&#34;</span>,
	
					<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
					<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
						<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;unmet_dependency&#34;</span> },
						<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProductIdentifier.json#&#34;</span> }
					},
					<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>, <span style="color:#b44">&#34;value&#34;</span>],
					<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
				},
				{
					<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceErrorOther&#34;</span>,
					<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A miscellaneous error.&#34;</span>,
	
					<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
					<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
						<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;other&#34;</span> },
						<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> }
					},
					<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>, <span style="color:#b44">&#34;value&#34;</span>],
					<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
				}
			]
		}
	}
}</code></pre>
</div>
<h4 id="5-4-4-2-example">5.4.4.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;errors&#34;</span>: [
		{
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;unmet_dependency&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;source&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: <span style="color:#b44">&#34;/home/example/foo.py&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>
			}
		},
		{
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;unmet_dependency&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;source&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: <span style="color:#b44">&#34;/home/example/bar.py&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>
			}
		}
	],
	<span style="color:#008000;font-weight:bold">&#34;notices&#34;</span>: []
}</code></pre>
</div>











<h3 id="5-4-5-serviceproduct">5.4.5. <code>ServiceProduct</code></h3>

<h4 id="5-4-5-1-schema">5.4.5.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceProduct&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A response containing a Product from a Service to be returned the Broker.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;product&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;Product.json#&#34;</span> },
		<span style="color:#008000;font-weight:bold">&#34;notices&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ServiceNotice.json#&#34;</span> }
		}
	},
	<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;product&#34;</span>],
	<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
}</code></pre>
</div>
<h4 id="5-4-5-2-example">5.4.5.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;product&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: <span style="color:#b44">&#34;/foo/bar.py&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;contents&#34;</span>: []
	},
	<span style="color:#008000;font-weight:bold">&#34;notices&#34;</span>: [
		{
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;unused_dependency&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;python&#34;</span>,
				<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: <span style="color:#b44">&#34;/home/example/old_file.py&#34;</span>
			}
		}
	]
}</code></pre>
</div>











<h3 id="5-4-6-servicenotice">5.4.6. <code>ServiceNotice</code></h3>

<h4 id="5-4-6-1-schema">5.4.6.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceNotice&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A message from a Broker to the Service signalling a non-error special condition.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;oneOf&#34;</span>: [
		{
			<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;ServiceNoticeUnusedDependency&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A notice that a dependency was unused when producing a Product.&#34;</span>,

			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;unused_dependency&#34;</span> },
				<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;ProductIdentifier.json#&#34;</span> }
			},
			<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>,
			<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>, <span style="color:#b44">&#34;value&#34;</span>]
		}
	]
}</code></pre>
</div>
<h4 id="5-4-6-2-example">5.4.6.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;unused_dependency&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;language&#34;</span>: <span style="color:#b44">&#34;haskell&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;path&#34;</span>: <span style="color:#b44">&#34;/home/example/.xmonad/xmonad.hs&#34;</span>
	}
}</code></pre>
</div>
</p>

<h2 id="5-5-optimizations">5.5. Optimizations</h2>

<p>The naiÌˆve Broker dependency-resolution algorithm is rather inefficient, and can be optimized in several ways.</p>

<h3 id="5-5-1-caching-the-dependency-graph">5.5.1. Caching the Dependency Graph</h3>

<p>Typically, a source file&rsquo;s current dependencies are very similar to its past dependencies.
This can be taken advantage of by caching the dependencies of a specific Product and requesting its dependencies before requesting the final Product.
This potentially could result in more work being done that needed (as a no-longer needed dependency is still computed).
Most edit actions don&rsquo;t affect the dependency graph, though, so this approach is efficient in the general case.</p>

<h3 id="5-5-2-inferring-dependencies">5.5.2. Inferring Dependencies</h3>

<p>The semantics specified here intentionally do not specify in what order the Broker should query Services to obtain a Product.
This allows a Broker to attempt to infer the dependencies a particular Product will have.
Although no heuristics are described here, they could in principle be developed and applied.</p>

<h2 id="5-6-service-protocol-extensions">5.6. Service Protocol Extensions</h2>

<p>Currently, there are no built-in extensions defined for the Service Protocol.
However, a Broker or Service MAY support arbitrary extensions whose names are in the form of the <code>NamespacedName</code> above.</p>

<h2 id="5-7-miscellanea">5.7. Miscellanea</h2>

<p>If the Broker detects a violation in the protocol from a Service, it SHOULD report the error to the Client via the <code>service_connect_error</code> branch of the <code>BrokerGetError</code> Message.</p>

<p>If a Service detects a violation in the protocol from a Broker, it SHOULD ignore the request, possibly logging it.
In this case, the Service SHOULD respond with an HTTP status of 503.</p>

<h1 id="6-products">6. Products</h1>

<p>Some fields are in common between most Product types.
The main two are <code>startByte</code> and <code>endByte</code>.
They represent the start and end of a selection of text from the corresponding source code.
<code>startByte</code> is inclusive, while <code>endByte</code> is exclusive.
The usage of &ldquo;byte&rdquo; in their names is significant &ndash; these MUST be the the byte indexes, rather than the character indexes.</p>

<p>









<h3 id="6-1-directory">6.1. <code>directory</code></h3>

<h4 id="6-1-1-schema">6.1.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;directory&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;A listing of a directory.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;absolute_path&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;oneOf&#34;</span>: [
					{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;file&#34;</span> },
					{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;directory&#34;</span> },
					{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;symlink&#34;</span> },
					{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;other&#34;</span> }
				]
			}
		},
		<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;name&#34;</span>, <span style="color:#b44">&#34;absolute_path&#34;</span>, <span style="color:#b44">&#34;type&#34;</span>],
		<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
	}
}</code></pre>
</div>
<h4 id="6-1-2-example">6.1.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">[
	{
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;foo.c&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;absolute_path&#34;</span>: <span style="color:#b44">&#34;/projects/bar/foo.c&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;file&#34;</span>
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;bar.c&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;absolute_path&#34;</span>: <span style="color:#b44">&#34;/projects/bar/bar.c&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;file&#34;</span>
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;name&#34;</span>: <span style="color:#b44">&#34;quux&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;absolute_path&#34;</span>: <span style="color:#b44">&#34;/projects/bar/quux&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;directory&#34;</span>
	}
]</code></pre>
</div>











<h3 id="6-2-errors">6.2. <code>errors</code></h3>

<h4 id="6-2-1-schema">6.2.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;errors&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;Syntactic or semantic errors detected in source code.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;message&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;#/definitions/byteOffset&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;#/definitions/byteOffset&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;severity&#34;</span>: {
				<span style="color:#008000;font-weight:bold">&#34;oneOf&#34;</span>: [
					{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;error&#34;</span> },
					{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;warning&#34;</span> },
					{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;info&#34;</span> }
				]
			}
		},
		<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;message&#34;</span>, <span style="color:#b44">&#34;startByte&#34;</span>, <span style="color:#b44">&#34;endByte&#34;</span>],
		<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
	},

	<span style="color:#008000;font-weight:bold">&#34;definitions&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;byteOffset&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;minimum&#34;</span>: <span style="color:#666">0</span>
		}
	}
}</code></pre>
</div>
<h4 id="6-2-2-example">6.2.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">[
	{
		<span style="color:#008000;font-weight:bold">&#34;message&#34;</span>: <span style="color:#b44">&#34;Invalid import: foo.bar&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">19</span>
	}
]</code></pre>
</div>











<h3 id="6-3-highlighting">6.3. <code>highlighting</code></h3>

<h4 id="6-3-1-schema">6.3.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;highlighting&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;Token information to be used for highlighting source code.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;array&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;items&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
		<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;#/definitions/byteOffset&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;#/definitions/byteOffset&#34;</span> },
			<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;#/definitions/color&#34;</span> }
		},
		<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;startByte&#34;</span>, <span style="color:#b44">&#34;endByte&#34;</span>, <span style="color:#b44">&#34;color&#34;</span>],
		<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
	},

	<span style="color:#008000;font-weight:bold">&#34;definitions&#34;</span>: {
		<span style="color:#008000;font-weight:bold">&#34;byteOffset&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;minimum&#34;</span>: <span style="color:#666">0</span>
		},
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;oneOf&#34;</span>: [
				{
					<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
					<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
						<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;token&#34;</span> },
						<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;$ref&#34;</span>: <span style="color:#b44">&#34;#/definitions/token&#34;</span> }
					},
					<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>, <span style="color:#b44">&#34;value&#34;</span>],
					<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
				},
				{
					<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;object&#34;</span>,
					<span style="color:#008000;font-weight:bold">&#34;properties&#34;</span>: {
						<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: { <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;palette&#34;</span> },
						<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: {
							<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;integer&#34;</span>,
							<span style="color:#008000;font-weight:bold">&#34;minimum&#34;</span>: <span style="color:#666">0</span>,
							<span style="color:#008000;font-weight:bold">&#34;maximum&#34;</span>: <span style="color:#666">15</span>
						}
					},
					<span style="color:#008000;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#b44">&#34;type&#34;</span>, <span style="color:#b44">&#34;value&#34;</span>],
					<span style="color:#008000;font-weight:bold">&#34;additionalProperties&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
				}
			]
		},
		<span style="color:#008000;font-weight:bold">&#34;token&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;oneOf&#34;</span>: [
				{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;comment&#34;</span> },
				{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;function&#34;</span> },
				{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;identifier&#34;</span> },
				{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;keyword&#34;</span> },
				{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;literal&#34;</span> },
				{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;operator&#34;</span> },
				{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;punctuation&#34;</span> },
				{ <span style="color:#008000;font-weight:bold">&#34;const&#34;</span>: <span style="color:#b44">&#34;type&#34;</span> }
			]
		}
	}
}</code></pre>
</div>
<h4 id="6-3-2-example">6.3.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">[
	{
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">0</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">1</span>,
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;token&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: <span style="color:#b44">&#34;punctuation&#34;</span>
		}
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">1</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">5</span>,
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;token&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: <span style="color:#b44">&#34;keyword&#34;</span>
		}
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">6</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">7</span>,
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;token&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: <span style="color:#b44">&#34;punctuation&#34;</span>
		}
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">7</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">10</span>,
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;token&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: <span style="color:#b44">&#34;identifier&#34;</span>
		}
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">10</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">11</span>,
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;token&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: <span style="color:#b44">&#34;punctuation&#34;</span>
		}
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">14</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">15</span>,
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;token&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: <span style="color:#b44">&#34;literal&#34;</span>
		}
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">15</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">16</span>,
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;token&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: <span style="color:#b44">&#34;punctuation&#34;</span>
		}
	},
	{
		<span style="color:#008000;font-weight:bold">&#34;startByte&#34;</span>: <span style="color:#666">18</span>,
		<span style="color:#008000;font-weight:bold">&#34;endByte&#34;</span>: <span style="color:#666">20</span>,
		<span style="color:#008000;font-weight:bold">&#34;color&#34;</span>: {
			<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;palette&#34;</span>,
			<span style="color:#008000;font-weight:bold">&#34;value&#34;</span>: <span style="color:#666">3</span>
		}
	}
]</code></pre>
</div>











<h3 id="6-4-source">6.4. <code>source</code></h3>

<h4 id="6-4-1-schema">6.4.1. Schema</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#008000;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#b44">&#34;http://json-schema.org/draft-06/schema#&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;title&#34;</span>: <span style="color:#b44">&#34;source&#34;</span>,
	<span style="color:#008000;font-weight:bold">&#34;description&#34;</span>: <span style="color:#b44">&#34;Source code.&#34;</span>,

	<span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#b44">&#34;string&#34;</span>
}</code></pre>
</div>
<h4 id="6-4-2-example">6.4.2. Example</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#b44">&#34;(define (hello)\n  (println \&#34;Hello, world!\&#34;))\n\n(hello)\n&#34;</span></code></pre>
</div>
</p>

<h1 id="7-security-considerations">7. Security Considerations</h1>

<h2 id="7-1-remote-access-to-local-files">7.1. Remote Access To Local Files</h2>

<p>The Broker sends arbitrary files to Services, which may be running on a different machine.
A malicious Service could therefore request a sensitive file (for example, <code>~/.ssh/id_rsa</code>).
As a result, a Broker MAY claim such a file does not exist.</p>

<p>Furthermore, a security-conscious user MAY run the Broker in a virtual machine or container, only giving access to user files in specific directories.</p>

<h2 id="7-2-encrypted-transport">7.2. Encrypted Transport</h2>

<p>HTTP/2 optionally supports TLS encryption.
Most HTTP/2 implementations require encryption, so Clients, Brokers, and Services SHOULD support TLS encryption.
Due to the relative difficulty of obtaining a TLS certificate for a local Service, Clients SHOULD support connecting to a Broker that does not support TLS or uses a self-signed certificate.</p>

<h1 id="8-further-work">8. Further Work</h1>

<h2 id="8-1-binary-encoding-instead-of-json">8.1. Binary Encoding instead of JSON</h2>

<p>A speed boost could potentially be gained by using CBOR (<a href="#rfc7049">[RFC7049]</a>)
, MessagePack (<a href="#msgpack">[MSGPACK]</a>)
 or a similar format instead of JSON.
This could be added as a simple protocol extension.</p>

<h2 id="8-2-asynchronous-communication">8.2. Asynchronous Communication</h2>

<p>Re-adding support for asynchronous communication between Clients and Brokers as a protocol extension could be implemented via polling (which is relatively efficient in HTTP/2 due to request multiplexing), WebSockets (in HTTP/1.1 only), or with a chunked response.</p>

<h2 id="8-3-commands">8.3. Commands</h2>

<p>Previous versions of Monto supported arbitrary commands being run by the Service, for example, renaming a function everywhere it appears (in all files).
This is difficult to do while allowing Services to be run on remote machines.
It could be achieved by allowing Services to request file writes in addition to reads, but would probably require a large amount of overhead, and come with its own security risks.</p>

<h2 id="8-4-stateful-services">8.4. Stateful Services</h2>

<p>Some services inherently have state, such as debuggers.
Unfortunately, this model does not translate well to the Monto Version 3 Protocol &ndash; services may be shared with multiple brokers over the network.
A possible solution would be to use a &ldquo;state token,&rdquo; a unique identifier for each session.</p>

<h2 id="8-5-caching-products">8.5. Caching Products</h2>

<p>Most projects&rsquo; dependencies contains more source code than the projects themselves &ndash; the dependencies&rsquo; source code is unlikely to change, and it is wasteful to send it over the network with each request.
A simple Service Protocol Extension that remedies this problem would be a caching mechanism, in which the Broker would send an opaque identifier (e.g. a SHA-256 hash) for the dependencies instead of the dependencies themselves.
A Service could then either use a cached copy, if one exists, or fail with an error similar to the <code>ServiceErrorUnmetDependency</code> error if the dependency is not in the cache.</p>

<h2 id="8-6-incremental-product-transfer">8.6. Incremental Product Transfer</h2>

<p>The next step on the above would be to send all changes to files as deltas from a previous state.
This would greatly decrease the amount of network bandwidth required, and would be a relatively minor variation on the above.</p>

<h2 id="8-7-incremental-compilation">8.7. Incremental Compilation</h2>

<p>Once an incremental transfer system exists, full incremental compilation is easy to support.
A Service would only have to cache the last Product cooresponding to the input, and then could use it in the next compilation for that Product.</p>

<h2 id="8-8-flow-control">8.8. Flow Control</h2>

<p>This would be a simple Client Protocol Extension adding a <code>flow_control</code> error possibility.
When the Broker detects that requests for Products are being sent faster than Services can fulfill them, it sends this error.
The Client SHOULD reduce its request frequency in response.</p>

<h1 id="9-references">9. References</h1>

<h2 id="9-1-normative-references">9.1. Normative References</h2>

<p id="jsonschema">
	[JSONSCHEMA]: Wright, A., Ed., and H. Andrews, Ed., &ldquo;JSON Schema: A Media Type for Describing JSON Documents&rdquo;, <a href="https://tools.ietf.org/html/draft-wright-json-schema-01">draft-wright-json-schema-01</a>, April 2017.
</p>

<p id="mitmproxy">
	[MITMPROXY]: &ldquo;mitmproxy - home&rdquo;, <a href="https://mitmproxy.org/">https://mitmproxy.org/</a>.
</p>

<p id="monto-2014">
	[MONTO-2014]: Sloane, A., Roberts, M., Buckley, S., and S. Muscat, &ldquo;Monto: A Disintegrated Development Environment&rdquo;, <a href="https://doi.org/10.1007/978-3-319-11245-9_12">doi:10.1007/978-3-319-11245-9_12</a>, September 2014.
</p>

<p id="monto-2016">
	[MONTO-2016]: Keidel, S., Pfeiffer, W., and S. Erdweg, &ldquo;The IDE Portability Problem and Its Solution in Monto&rdquo;, <a href="http://dx.doi.org/10.1145/2997364.2997368">doi:10.1145/2997364.2997368</a>, November 2016.
</p>

<p id="msgpack">
	[MSGPACK]: Furuhashi, S., &ldquo;MessagePack: It&rsquo;s like JSON, but fast and small.&ldquo;, <a href="https://msgpack.org/">https://msgpack.org/</a>.
</p>

<p id="postman">
	[POSTMAN]: &ldquo;Postman | Supercharge your API workflow&rdquo;, <a href="https://www.getpostman.com/">https://www.getpostman.com/</a>.
</p>

<p id="rfc2119">
	[RFC2119]: Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels&rdquo;, <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="https://tools.ietf.org/html/rfc2119">RFC 2119</a>, March 1997.
</p>

<p id="rfc7049">
	[RFC7049]: Bormann, C., and P. Hoffman, &ldquo;Concise Binary Object Representation (CBOR)&rdquo;, <a href="https://tools.ietf.org/html/rfc7049">RFC 7049</a>, October 2013.
</p>

<p id="rfc7159">
	[RFC7159]: Bray, T., &ldquo;The JavaScript Object Notation (JSON) Data Interchange Format&rdquo;, <a href="https://tools.ietf.org/html/rfc7159">RFC 7159</a>, March 2014.
</p>

<p id="rfc7230">
	[RFC7230]: Fielding, R., Ed., and J. Reschke, Ed., &ldquo;Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing&rdquo;, <a href="https://tools.ietf.org/html/rfc7230">RFC 7230</a>, June 2014.
</p>

<p id="rfc7540">
	[RFC7540]: Belshe, M., Peon, R., and M. Thomson, Ed., &ldquo;Hypertext Transfer Protocol Version 2 (HTTP/2)&rdquo;, <a href="https://tools.ietf.org/html/rfc7540">RFC 7540</a>, May 2015.
</p>

<p id="semver">
	[SEMVER]: &ldquo;Semantic Versioning 2.0.0&rdquo;, <a href="http://semver.org/spec/v2.0.0.html">http://semver.org/spec/v2.0.0.html</a>.
</p>

<p id="zeromq">
	[ZEROMQ]: &ldquo;Distributed Messaging - zeromq&rdquo;, <a href="http://zeromq.org/">http://zeromq.org/</a>.
</p>

		</main>
		<script>
			var sectionAnchors = new AnchorJS();
			sectionAnchors.options.class = "section-anchor";
			sectionAnchors.options.icon = "#";
			sectionAnchors.add("main h1, main h2, main h3, main h4, main h5, main h6");

			
			

		</script>
	</body>
</html>
